# Script para hacer build del backend localmente y subirlo a Oracle
# Uso: .\scripts\deploy-backend.ps1

$ErrorActionPreference = "Stop"

# Configuraci√≥n
$SSH_HOST = "137.131.174.209"
$SSH_USER = "ubuntu"
$SSH_KEY = "$env:USERPROFILE\Desktop\ssh-key-2025-11-14.key"
$PROJECT_PATH = "~/receptionistAI-main"
$BACKEND_SERVICE = "receptionistai.service"

Write-Host "üöÄ Iniciando deploy del backend..." -ForegroundColor Cyan
Write-Host ""

# Paso 1: Verificar que estamos en el directorio correcto
if (-not (Test-Path "api\package.json")) {
    Write-Host "‚ùå Error: No se encontr√≥ api\package.json" -ForegroundColor Red
    Write-Host "   Aseg√∫rate de ejecutar este script desde la ra√≠z del proyecto" -ForegroundColor Yellow
    exit 1
}listo ya cambie 

# Paso 2: Verificar que existe la clave SSH
if (-not (Test-Path $SSH_KEY)) {
    Write-Host "‚ùå Error: No se encontr√≥ la clave SSH en: $SSH_KEY" -ForegroundColor Red
    Write-Host "   Por favor, verifica la ruta de la clave SSH" -ForegroundColor Yellow
    exit 1
}

# Paso 3: Build del backend
Write-Host "üì¶ Compilando backend..." -ForegroundColor Cyan
Set-Location api

try {
    npm run build
    if ($LASTEXITCODE -ne 0) {
        throw "Build fall√≥ con c√≥digo $LASTEXITCODE"
    }
    Write-Host "‚úÖ Build completado" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Error al compilar: $_" -ForegroundColor Red
    Set-Location ..
    exit 1
}

# Paso 4: Crear archivo tar.gz
Write-Host "üì¶ Creando archivo comprimido..." -ForegroundColor Cyan
Set-Location ..

# Limpiar archivo anterior si existe
if (Test-Path "api-dist.tar.gz") {
    Remove-Item "api-dist.tar.gz" -Force
}

# Crear tar.gz (usando tar de Windows 10+ o 7zip)
try {
    # Intentar con tar nativo de Windows
    tar -czf api-dist.tar.gz -C api dist
    if ($LASTEXITCODE -ne 0) {
        throw "Error al crear tar.gz"
    }
    Write-Host "‚úÖ Archivo api-dist.tar.gz creado" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Error al crear tar.gz: $_" -ForegroundColor Red
    Write-Host "   Aseg√∫rate de tener tar instalado (Windows 10+ lo incluye)" -ForegroundColor Yellow
    exit 1
}

# Paso 5: Subir archivo a Oracle
Write-Host "üì§ Subiendo archivo a Oracle..." -ForegroundColor Cyan
try {
    scp -i $SSH_KEY api-dist.tar.gz "${SSH_USER}@${SSH_HOST}:/tmp/"
    if ($LASTEXITCODE -ne 0) {
        throw "Error al subir archivo"
    }
    Write-Host "‚úÖ Archivo subido correctamente" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Error al subir archivo: $_" -ForegroundColor Red
    exit 1
}

# Paso 6: Extraer y reiniciar servicio en Oracle
Write-Host "üîÑ Desplegando y reiniciando servicio..." -ForegroundColor Cyan
try {
    # Crear script para SSH (escapar variables de PowerShell)
    $deployCommands = @(
        "set -e",
        "cd $PROJECT_PATH",
        "echo 'üì¶ Extrayendo archivos...'",
        "tar xzf /tmp/api-dist.tar.gz -C api",
        "echo 'üßπ Limpiando archivo temporal...'",
        "rm /tmp/api-dist.tar.gz",
        "echo 'üîÑ Reiniciando servicio...'",
        "sudo systemctl restart $BACKEND_SERVICE",
        "echo '‚úÖ Deploy completado'"
    )
    
    # Unir comandos con && y pasar a SSH
    $scriptToExecute = $deployCommands -join " && "
    $sshArgs = @(
        "-i", $SSH_KEY,
        "${SSH_USER}@${SSH_HOST}",
        $scriptToExecute
    )
    
    & ssh $sshArgs
    
    if ($LASTEXITCODE -ne 0) {
        throw "Error al desplegar"
    }
    Write-Host "‚úÖ Deploy completado" -ForegroundColor Green
} catch {
    Write-Host "‚ùå Error al desplegar: $_" -ForegroundColor Red
    exit 1
}

# Paso 7: Limpiar archivo local
Write-Host "üßπ Limpiando archivo local..." -ForegroundColor Cyan
Remove-Item "api-dist.tar.gz" -Force
Write-Host "‚úÖ Archivo local eliminado" -ForegroundColor Green

Write-Host ""
Write-Host "üéâ Deploy completado exitosamente!" -ForegroundColor Green
Write-Host ""
Write-Host "Verifica el estado del servicio:" -ForegroundColor Cyan
Write-Host "  ssh -i $SSH_KEY ${SSH_USER}@${SSH_HOST} 'sudo systemctl status $BACKEND_SERVICE'" -ForegroundColor Yellow
Write-Host ""

